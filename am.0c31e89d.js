var r,e,t,a={},i={};a.create=function(r,e,t){return{x:r,y:e,z:t}},a.dot=function(r,e){return r.x*e.x+r.y*e.y+r.z*e.z},a.cross=function(r,e,t){r.x=e.y*t.z-e.z*t.y,r.y=e.z*t.x-e.x*t.z,r.z=e.x*t.y-e.y*t.x},a.normalize=function(r){var e=r.x*r.x+r.y*r.y+r.z*r.z;e>1e-5&&(e=1/Math.sqrt(e),r.x*=e,r.y*=e,r.z*=e)},a.arrayForm=function(r){return r.array?(r.array[0]=r.x,r.array[1]=r.y,r.array[2]=r.z):r.array=new Float32Array([r.x,r.y,r.z]),r.array},i.createIdentity=function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},i.loadProjection=function(r,e,t,a,i){var o=a*Math.tan(t*Math.PI/180*.5)*2;r[0]=2*a/(o*e),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2*a/o,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-(i+a)/(i-a),r[11]=-1,r[12]=0,r[13]=0,r[14]=-2*i*a/(i-a),r[15]=0},i.loadLookAt=function(r,e,t,i){var o=a.create(e.x-t.x,e.y-t.y,e.z-t.z);a.normalize(o);var n=a.create(1,0,0);a.cross(n,i,o),a.normalize(n);var f=a.create(1,0,0);a.cross(f,o,n),a.normalize(f),r[0]=n.x,r[1]=f.x,r[2]=o.x,r[3]=0,r[4]=n.y,r[5]=f.y,r[6]=o.y,r[7]=0,r[8]=n.z,r[9]=f.z,r[10]=o.z,r[11]=0,r[12]=-(e.x*r[0]+e.y*r[4]+e.z*r[8]),r[13]=-(e.x*r[1]+e.y*r[5]+e.z*r[9]),r[14]=-(e.x*r[2]+e.y*r[6]+e.z*r[10]),r[15]=1};var o={start:0,prev:0,delta:0,elapsed:0},n={width:0,height:0,aspect:1,array:new Float32Array(3),halfWidth:0,halfHeight:0,halfArray:new Float32Array(3)};function f(r,e){var a=t.createShader(r);if(t.shaderSource(a,e),t.compileShader(a),!t.getShaderParameter(a,t.COMPILE_STATUS)){var i=t.getShaderInfoLog(a);return t.deleteShader(a),console.error(i),null}return a}function u(r,e,a,i){var o=f(t.VERTEX_SHADER,r),n=f(t.FRAGMENT_SHADER,e);if(null==o||null==n)return null;var u=t.createProgram();if(t.attachShader(u,o),t.attachShader(u,n),t.deleteShader(o),t.deleteShader(n),t.linkProgram(u),!t.getProgramParameter(u,t.LINK_STATUS))return console.error(t.getProgramInfoLog(u)),null;if(a){u.uniforms={};for(let r=0;r<a.length;r++)u.uniforms[a[r]]=t.getUniformLocation(u,a[r])}if(i){u.attributes={};for(var l=0;l<i.length;l++){var s=i[l];u.attributes[s]=t.getAttribLocation(u,s)}}return u}function l(r){for(var e in t.useProgram(r),r.attributes)t.enableVertexAttribArray(r.attributes[e])}function s(r){for(var e in r.attributes)t.disableVertexAttribArray(r.attributes[e]);t.useProgram(null)}n.setSize=function(r,e){n.width=r,n.height=e,n.aspect=n.width/n.height,n.array[0]=n.width,n.array[1]=n.height,n.array[2]=n.aspect,n.halfWidth=Math.floor(r/2),n.halfHeight=Math.floor(e/2),n.halfArray[0]=n.halfWidth,n.halfArray[1]=n.halfHeight,n.halfArray[2]=n.halfWidth/n.halfHeight};var m={angle:60,nearfar:new Float32Array([.1,100]),matrix:i.createIdentity()},d={position:a.create(0,0,100),lookat:a.create(0,0,0),up:a.create(0,1,0),dof:a.create(10,4,8),matrix:i.createIdentity()},h={},E=!1,c=function(){this.velocity=[,,,],this.rotation=[,,,],this.position=[,,,],this.euler=[,,,],this.size=1,this.alpha=1,this.zkey=0};function R(r,e,a,i){var o={},n=["uResolution","uSrc","uDelta"];a&&(n=n.concat(a));var f=["aPosition"];return i&&(f=f.concat(i)),o.program=u(r,e,n,f),l(o.program),o.dataArray=new Float32Array([-1,-1,1,-1,-1,1,1,1]),o.buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,o.buffer),t.bufferData(t.ARRAY_BUFFER,o.dataArray,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),s(o.program),o}function y(r,e){var a=r.program;l(a),t.uniform3fv(a.uniforms.uResolution,n.array),null!=e&&(t.uniform2fv(a.uniforms.uDelta,e.dtxArray),t.uniform1i(a.uniforms.uSrc,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.texture))}function T(r){t.bindBuffer(t.ARRAY_BUFFER,r.buffer),t.vertexAttribPointer(r.program.attributes.aPosition,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLE_STRIP,0,4)}function A(r){s(r.program)}c.prototype.setVelocity=function(r,e,t){this.velocity[0]=r,this.velocity[1]=e,this.velocity[2]=t},c.prototype.setRotation=function(r,e,t){this.rotation[0]=r,this.rotation[1]=e,this.rotation[2]=t},c.prototype.setPosition=function(r,e,t){this.position[0]=r,this.position[1]=e,this.position[2]=t},c.prototype.setEulerAngles=function(r,e,t){this.euler[0]=r,this.euler[1]=e,this.euler[2]=t},c.prototype.setSize=function(r){this.size=r},c.prototype.update=function(r,e){this.position[0]+=this.velocity[0]*r,this.position[1]+=this.velocity[1]*r,this.position[2]+=this.velocity[2]*r,this.euler[0]+=this.rotation[0]*r,this.euler[1]+=this.rotation[1]*r,this.euler[2]+=this.rotation[2]*r};var F={};function p(){!function(){h.area=a.create(20,20,20),h.area.x=h.area.y*n.aspect,h.fader.x=10,h.fader.y=h.area.z,h.fader.z=.1;for(var r=2*Math.PI,e=a.create(0,0,0),t=0,i=function(){return 2*Math.random()-1},o=0;o<h.numFlowers;o++){var f=h.particles[o];e.x=.3*i()+.8,e.y=.2*i()-1,e.z=.3*i()+.5,a.normalize(e),t=2+1*Math.random(),f.setVelocity(e.x*t,e.y*t,e.z*t),f.setRotation(i()*r*.5,i()*r*.5,i()*r*.5),f.setPosition(i()*h.area.x,i()*h.area.y,i()*h.area.z),f.setEulerAngles(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2),f.setSize(.9+.1*Math.random())}}(),d.position.z=h.area.z+m.nearfar[0],m.angle=180*Math.atan2(h.area.y,d.position.z+h.area.z)/Math.PI*2,i.loadProjection(m.matrix,n.aspect,m.angle,m.nearfar[0],m.nearfar[1])}function B(r){x(document.getElementById("sakura")),_(),E&&p()}function _(){n.setSize(t.canvas.width,t.canvas.height),t.clearColor(.2,.2,.5,1),t.viewport(0,0,n.width,n.height);var r=function(r,e,a){var i,o=n[r];o&&(t.deleteFramebuffer(o.frameBuffer),t.deleteRenderbuffer(o.renderBuffer),t.deleteTexture(o.texture)),n[r]=((i={width:e,height:a,sizeArray:new Float32Array([e,a,e/a]),dtxArray:new Float32Array([1/e,1/a])}).frameBuffer=t.createFramebuffer(),i.renderBuffer=t.createRenderbuffer(),i.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,i.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,a,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.bindFramebuffer(t.FRAMEBUFFER,i.frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i.texture,0),t.bindRenderbuffer(t.RENDERBUFFER,i.renderBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e,a),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i.renderBuffer),t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),i)};r("mainRT",n.width,n.height),r("wFullRT0",n.width,n.height),r("wFullRT1",n.width,n.height),r("wHalfRT0",n.halfWidth,n.halfHeight),r("wHalfRT1",n.halfWidth,n.halfHeight)}function x(r){var e=document.body,t=document.documentElement;fullw=Math.max(e.clientWidth,e.scrollWidth,t.scrollWidth,t.clientWidth),fullh=Math.max(e.clientHeight,e.scrollHeight,t.scrollHeight,t.clientHeight),r.width=fullw,r.height=fullh}window.addEventListener("load",function(r){var e,f,g,v=document.getElementById("sakura");try{x(v),t=v.getContext("experimental-webgl")}catch(r){alert("WebGL not supported."+r),console.error(r);return}window.addEventListener("resize",B),_(),g=document.getElementById("fx_common_vsh").textContent,f=document.getElementById("bg_fsh").textContent,F.sceneBg=R(g,f,["uTimes"],null),f=document.getElementById("fx_brightbuf_fsh").textContent,F.mkBrightBuf=R(g,f,null,null),f=document.getElementById("fx_dirblur_r4_fsh").textContent,F.dirBlur=R(g,f,["uBlurDir"],null),e=document.getElementById("pp_final_vsh").textContent,f=document.getElementById("pp_final_fsh").textContent,F.finalComp=R(e,f,["uBloom"],null),function(){var r=t.getParameter(t.ALIASED_POINT_SIZE_RANGE);n.pointSize={min:r[0],max:r[1]};var e=document.getElementById("sakura_point_vsh").textContent,i=document.getElementById("sakura_point_fsh").textContent;h.program=u(e,i,["uProjection","uModelview","uResolution","uOffset","uDOF","uFade"],["aPosition","aEuler","aMisc"]),l(h.program),h.offset=new Float32Array([0,0,0]),h.fader=a.create(0,10,0),h.numFlowers=1600,h.particles=Array(h.numFlowers),h.dataArray=new Float32Array(8*h.numFlowers),h.positionArrayOffset=0,h.eulerArrayOffset=3*h.numFlowers,h.miscArrayOffset=6*h.numFlowers,h.buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,h.buffer),t.bufferData(t.ARRAY_BUFFER,h.dataArray,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),s(h.program);for(var o=0;o<h.numFlowers;o++)h.particles[o]=new c}(),E=!0,p(),o.start=new Date,o.prev=o.start,function r(){var e=new Date;o.elapsed=(e-o.start)/1e3,o.delta=(e-o.prev)/1e3,o.prev=e,requestAnimationFrame(r),i.loadLookAt(d.matrix,d.position,d.lookat,d.up),t.enable(t.DEPTH_TEST),t.bindFramebuffer(t.FRAMEBUFFER,n.mainRT.frameBuffer),t.viewport(0,0,n.mainRT.width,n.mainRT.height),t.clearColor(.005,0,.05,0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.disable(t.DEPTH_TEST),y(F.sceneBg,null),t.uniform2f(F.sceneBg.program.uniforms.uTimes,o.elapsed,o.delta),T(F.sceneBg),A(F.sceneBg),t.enable(t.DEPTH_TEST),function(){var r=2*Math.PI;h.area.x,h.area.y,h.area.z;for(var e=function(r,e,t){Math.abs(r.position[e])-.5*r.size>t&&(r.position[e]>0?r.position[e]-=2*t:r.position[e]+=2*t)},i=function(e,t){e.euler[t]=e.euler[t]%r,e.euler[t]<0&&(e.euler[t]+=r)},f=0;f<h.numFlowers;f++){var u=h.particles[f];u.update(o.delta,o.elapsed),e(u,0,h.area.x),e(u,1,h.area.y),e(u,2,h.area.z),i(u,0),i(u,1),i(u,2),u.alpha=1,u.zkey=d.matrix[2]*u.position[0]+d.matrix[6]*u.position[1]+d.matrix[10]*u.position[2]+d.matrix[14]}h.particles.sort(function(r,e){return r.zkey-e.zkey});for(var E=h.positionArrayOffset,c=h.eulerArrayOffset,R=h.miscArrayOffset,f=0;f<h.numFlowers;f++){var u=h.particles[f];h.dataArray[E]=u.position[0],h.dataArray[E+1]=u.position[1],h.dataArray[E+2]=u.position[2],E+=3,h.dataArray[c]=u.euler[0],h.dataArray[c+1]=u.euler[1],h.dataArray[c+2]=u.euler[2],c+=3,h.dataArray[R]=u.size,h.dataArray[R+1]=u.alpha,R+=2}t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);var y=h.program;l(y),t.uniformMatrix4fv(y.uniforms.uProjection,!1,m.matrix),t.uniformMatrix4fv(y.uniforms.uModelview,!1,d.matrix),t.uniform3fv(y.uniforms.uResolution,n.array),t.uniform3fv(y.uniforms.uDOF,a.arrayForm(d.dof)),t.uniform3fv(y.uniforms.uFade,a.arrayForm(h.fader)),t.bindBuffer(t.ARRAY_BUFFER,h.buffer),t.bufferData(t.ARRAY_BUFFER,h.dataArray,t.DYNAMIC_DRAW),t.vertexAttribPointer(y.attributes.aPosition,3,t.FLOAT,!1,0,h.positionArrayOffset*Float32Array.BYTES_PER_ELEMENT),t.vertexAttribPointer(y.attributes.aEuler,3,t.FLOAT,!1,0,h.eulerArrayOffset*Float32Array.BYTES_PER_ELEMENT),t.vertexAttribPointer(y.attributes.aMisc,2,t.FLOAT,!1,0,h.miscArrayOffset*Float32Array.BYTES_PER_ELEMENT);for(var f=1;f<2;f++){var T=-2*f;h.offset[0]=-1*h.area.x,h.offset[1]=-1*h.area.y,h.offset[2]=h.area.z*T,t.uniform3fv(y.uniforms.uOffset,h.offset),t.drawArrays(t.POINT,0,h.numFlowers),h.offset[0]=-1*h.area.x,h.offset[1]=1*h.area.y,h.offset[2]=h.area.z*T,t.uniform3fv(y.uniforms.uOffset,h.offset),t.drawArrays(t.POINT,0,h.numFlowers),h.offset[0]=1*h.area.x,h.offset[1]=-1*h.area.y,h.offset[2]=h.area.z*T,t.uniform3fv(y.uniforms.uOffset,h.offset),t.drawArrays(t.POINT,0,h.numFlowers),h.offset[0]=1*h.area.x,h.offset[1]=1*h.area.y,h.offset[2]=h.area.z*T,t.uniform3fv(y.uniforms.uOffset,h.offset),t.drawArrays(t.POINT,0,h.numFlowers)}h.offset[0]=0,h.offset[1]=0,h.offset[2]=0,t.uniform3fv(y.uniforms.uOffset,h.offset),t.drawArrays(t.POINT,0,h.numFlowers),t.bindBuffer(t.ARRAY_BUFFER,null),s(y),t.enable(t.DEPTH_TEST),t.disable(t.BLEND)}(),function(){t.enable(t.TEXTURE_2D),t.disable(t.DEPTH_TEST);var r=function(r,e){t.bindFramebuffer(t.FRAMEBUFFER,r.frameBuffer),t.viewport(0,0,r.width,r.height),e&&(t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))};r(n.wHalfRT0,!0),y(F.mkBrightBuf,n.mainRT),T(F.mkBrightBuf),A(F.mkBrightBuf);for(var e=0;e<2;e++){var a=1.5+1*e,i=2+1*e;r(n.wHalfRT1,!0),y(F.dirBlur,n.wHalfRT0),t.uniform4f(F.dirBlur.program.uniforms.uBlurDir,a,0,i,0),T(F.dirBlur),A(F.dirBlur),r(n.wHalfRT0,!0),y(F.dirBlur,n.wHalfRT1),t.uniform4f(F.dirBlur.program.uniforms.uBlurDir,0,a,0,i),T(F.dirBlur),A(F.dirBlur)}t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,n.width,n.height),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),y(F.finalComp,n.mainRT),t.uniform1i(F.finalComp.program.uniforms.uBloom,1),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,n.wHalfRT0.texture),T(F.finalComp),A(F.finalComp),t.enable(t.DEPTH_TEST)}()}()}),(r=window)["r"+(e="equestAnimationFrame")]=r["r"+e]||r["webkitR"+e]||r["mozR"+e]||r["msR"+e]||r["oR"+e]||function(e){r.setTimeout(e,1e3/60)};