var e,t;let r;const a={},i={};a.create=function(e,t,r){return{x:e,y:t,z:r}},a.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},a.cross=function(e,t,r){e.x=t.y*r.z-t.z*r.y,e.y=t.z*r.x-t.x*r.z,e.z=t.x*r.y-t.y*r.x},a.normalize=function(e){let t=e.x*e.x+e.y*e.y+e.z*e.z;t>1e-5&&(t=1/Math.sqrt(t),e.x*=t,e.y*=t,e.z*=t)},a.arrayForm=function(e){return e.array?(e.array[0]=e.x,e.array[1]=e.y,e.array[2]=e.z):e.array=new Float32Array([e.x,e.y,e.z]),e.array},i.createIdentity=function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},i.loadProjection=function(e,t,r,a,i){let o=a*Math.tan(r*Math.PI/180*.5)*2;e[0]=2*a/(o*t),e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*a/o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=-(i+a)/(i-a),e[11]=-1,e[12]=0,e[13]=0,e[14]=-2*i*a/(i-a),e[15]=0},i.loadLookAt=function(e,t,r,i){let o=a.create(t.x-r.x,t.y-r.y,t.z-r.z);a.normalize(o);let n=a.create(1,0,0);a.cross(n,i,o),a.normalize(n);let f=a.create(1,0,0);a.cross(f,o,n),a.normalize(f),e[0]=n.x,e[1]=f.x,e[2]=o.x,e[3]=0,e[4]=n.y,e[5]=f.y,e[6]=o.y,e[7]=0,e[8]=n.z,e[9]=f.z,e[10]=o.z,e[11]=0,e[12]=-(t.x*e[0]+t.y*e[4]+t.z*e[8]),e[13]=-(t.x*e[1]+t.y*e[5]+t.z*e[9]),e[14]=-(t.x*e[2]+t.y*e[6]+t.z*e[10]),e[15]=1};const o={start:0,prev:0,delta:0,elapsed:0},n={width:0,height:0,aspect:1,array:new Float32Array(3),halfWidth:0,halfHeight:0,halfArray:new Float32Array(3)};function f(e,t){let a=r.createShader(e);if(r.shaderSource(a,t),r.compileShader(a),!r.getShaderParameter(a,r.COMPILE_STATUS)){let e=r.getShaderInfoLog(a);return r.deleteShader(a),console.error(e),null}return a}function l(e,t,a,i){let o=f(r.VERTEX_SHADER,e),n=f(r.FRAGMENT_SHADER,t);if(null==o||null==n)return null;let l=r.createProgram();if(r.attachShader(l,o),r.attachShader(l,n),r.deleteShader(o),r.deleteShader(n),r.linkProgram(l),!r.getProgramParameter(l,r.LINK_STATUS))return console.error(r.getProgramInfoLog(l)),null;if(a){l.uniforms={};for(let e=0;e<a.length;e++)l.uniforms[a[e]]=r.getUniformLocation(l,a[e])}if(i){l.attributes={};for(let e=0;e<i.length;e++){let t=i[e];l.attributes[t]=r.getAttribLocation(l,t)}}return l}function u(e){for(let t in r.useProgram(e),e.attributes)r.enableVertexAttribArray(e.attributes[t])}function s(e){for(let t in e.attributes)r.disableVertexAttribArray(e.attributes[t]);r.useProgram(null)}n.setSize=function(e,t){n.width=e,n.height=t,n.aspect=n.width/n.height,n.array[0]=n.width,n.array[1]=n.height,n.array[2]=n.aspect,n.halfWidth=Math.floor(e/2),n.halfHeight=Math.floor(t/2),n.halfArray[0]=n.halfWidth,n.halfArray[1]=n.halfHeight,n.halfArray[2]=n.halfWidth/n.halfHeight};const m={angle:60,nearfar:new Float32Array([.1,100]),matrix:i.createIdentity()},d={position:a.create(0,0,100),lookat:a.create(0,0,0),up:a.create(0,1,0),dof:a.create(10,4,8),matrix:i.createIdentity()},h={};let c=!1;const E=function(){this.velocity=[,,,],this.rotation=[,,,],this.position=[,,,],this.euler=[,,,],this.size=1,this.alpha=1,this.zkey=0};function R(e,t,a,i){let o={},n=["uResolution","uSrc","uDelta"];a&&(n=n.concat(a));let f=["aPosition"];return i&&(f=f.concat(i)),o.program=l(e,t,n,f),u(o.program),o.dataArray=new Float32Array([-1,-1,1,-1,-1,1,1,1]),o.buffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,o.buffer),r.bufferData(r.ARRAY_BUFFER,o.dataArray,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),s(o.program),o}function y(e,t){let a=e.program;u(a),r.uniform3fv(a.uniforms.uResolution,n.array),null!=t&&(r.uniform2fv(a.uniforms.uDelta,t.dtxArray),r.uniform1i(a.uniforms.uSrc,0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t.texture))}function T(e){r.bindBuffer(r.ARRAY_BUFFER,e.buffer),r.vertexAttribPointer(e.program.attributes.aPosition,2,r.FLOAT,!1,0,0),r.drawArrays(r.TRIANGLE_STRIP,0,4)}function A(e){s(e.program)}E.prototype.setVelocity=function(e,t,r){this.velocity[0]=e,this.velocity[1]=t,this.velocity[2]=r},E.prototype.setRotation=function(e,t,r){this.rotation[0]=e,this.rotation[1]=t,this.rotation[2]=r},E.prototype.setPosition=function(e,t,r){this.position[0]=e,this.position[1]=t,this.position[2]=r},E.prototype.setEulerAngles=function(e,t,r){this.euler[0]=e,this.euler[1]=t,this.euler[2]=r},E.prototype.setSize=function(e){this.size=e},E.prototype.update=function(e,t){this.position[0]+=this.velocity[0]*e,this.position[1]+=this.velocity[1]*e,this.position[2]+=this.velocity[2]*e,this.euler[0]+=this.rotation[0]*e,this.euler[1]+=this.rotation[1]*e,this.euler[2]+=this.rotation[2]*e};const F={};function p(){!function(){h.area=a.create(20,20,20),h.area.x=h.area.y*n.aspect,h.fader.x=10,h.fader.y=h.area.z,h.fader.z=.1;let e=2*Math.PI,t=a.create(0,0,0),r=0,i=function(){return 2*Math.random()-1};for(let o=0;o<h.numFlowers;o++){let n=h.particles[o];t.x=.3*i()+.8,t.y=.2*i()-1,t.z=.3*i()+.5,a.normalize(t),r=2+1*Math.random(),n.setVelocity(t.x*r,t.y*r,t.z*r),n.setRotation(i()*e*.5,i()*e*.5,i()*e*.5),n.setPosition(i()*h.area.x,i()*h.area.y,i()*h.area.z),n.setEulerAngles(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2),n.setSize(.9+.1*Math.random())}}(),d.position.z=h.area.z+m.nearfar[0],m.angle=180*Math.atan2(h.area.y,d.position.z+h.area.z)/Math.PI*2,i.loadProjection(m.matrix,n.aspect,m.angle,m.nearfar[0],m.nearfar[1])}function B(e){x(document.getElementById("sakura")),_(),c&&p()}function _(){n.setSize(r.canvas.width,r.canvas.height),r.clearColor(.2,.2,.5,1),r.viewport(0,0,n.width,n.height);let e=function(e,t,a){let i=n[e];i&&(r.deleteFramebuffer(i.frameBuffer),r.deleteRenderbuffer(i.renderBuffer),r.deleteTexture(i.texture)),n[e]=function(e,t){let a={width:e,height:t,sizeArray:new Float32Array([e,t,e/t]),dtxArray:new Float32Array([1/e,1/t])};return a.frameBuffer=r.createFramebuffer(),a.renderBuffer=r.createRenderbuffer(),a.texture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,a.texture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,t,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.bindFramebuffer(r.FRAMEBUFFER,a.frameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,a.texture,0),r.bindRenderbuffer(r.RENDERBUFFER,a.renderBuffer),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,e,t),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,a.renderBuffer),r.bindTexture(r.TEXTURE_2D,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null),a}(t,a)};e("mainRT",n.width,n.height),e("wFullRT0",n.width,n.height),e("wFullRT1",n.width,n.height),e("wHalfRT0",n.halfWidth,n.halfHeight),e("wHalfRT1",n.halfWidth,n.halfHeight)}function x(e){let t=document.body,r=document.documentElement;fullw=Math.max(t.clientWidth,t.scrollWidth,r.scrollWidth,r.clientWidth),fullh=Math.max(t.clientHeight,t.scrollHeight,r.scrollHeight,r.clientHeight),e.width=fullw,e.height=fullh}window.addEventListener("load",function(e){let t=document.getElementById("sakura");try{x(t),r=t.getContext("experimental-webgl")}catch(e){alert("WebGL not supported."+e),console.error(e);return}window.addEventListener("resize",B),_(),function(){let e,t;let r=document.getElementById("fx_common_vsh").textContent;t=document.getElementById("bg_fsh").textContent,F.sceneBg=R(r,t,["uTimes"],null),t=document.getElementById("fx_brightbuf_fsh").textContent,F.mkBrightBuf=R(r,t,null,null),t=document.getElementById("fx_dirblur_r4_fsh").textContent,F.dirBlur=R(r,t,["uBlurDir"],null),e=document.getElementById("pp_final_vsh").textContent,t=document.getElementById("pp_final_fsh").textContent,F.finalComp=R(e,t,["uBloom"],null)}(),function(){let e=r.getParameter(r.ALIASED_POINT_SIZE_RANGE);n.pointSize={min:e[0],max:e[1]};let t=document.getElementById("sakura_point_vsh").textContent,i=document.getElementById("sakura_point_fsh").textContent;h.program=l(t,i,["uProjection","uModelview","uResolution","uOffset","uDOF","uFade"],["aPosition","aEuler","aMisc"]),u(h.program),h.offset=new Float32Array([0,0,0]),h.fader=a.create(0,10,0),h.numFlowers=1600,h.particles=Array(h.numFlowers),h.dataArray=new Float32Array(8*h.numFlowers),h.positionArrayOffset=0,h.eulerArrayOffset=3*h.numFlowers,h.miscArrayOffset=6*h.numFlowers,h.buffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,h.buffer),r.bufferData(r.ARRAY_BUFFER,h.dataArray,r.DYNAMIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),s(h.program);for(let e=0;e<h.numFlowers;e++)h.particles[e]=new E}(),c=!0,p(),o.start=new Date,o.prev=o.start,function e(){let t=new Date;o.elapsed=(t-o.start)/1e3,o.delta=(t-o.prev)/1e3,o.prev=t,requestAnimationFrame(e),i.loadLookAt(d.matrix,d.position,d.lookat,d.up),r.enable(r.DEPTH_TEST),r.bindFramebuffer(r.FRAMEBUFFER,n.mainRT.frameBuffer),r.viewport(0,0,n.mainRT.width,n.mainRT.height),r.clearColor(.005,0,.05,0),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.disable(r.DEPTH_TEST),y(F.sceneBg,null),r.uniform2f(F.sceneBg.program.uniforms.uTimes,o.elapsed,o.delta),T(F.sceneBg),A(F.sceneBg),r.enable(r.DEPTH_TEST),function(){let e=2*Math.PI;h.area.x,h.area.y,h.area.z;let t=function(e,t,r){Math.abs(e.position[t])-.5*e.size>r&&(e.position[t]>0?e.position[t]-=2*r:e.position[t]+=2*r)},i=function(t,r){t.euler[r]=t.euler[r]%e,t.euler[r]<0&&(t.euler[r]+=e)};for(let e=0;e<h.numFlowers;e++){let r=h.particles[e];r.update(o.delta,o.elapsed),t(r,0,h.area.x),t(r,1,h.area.y),t(r,2,h.area.z),i(r,0),i(r,1),i(r,2),r.alpha=1,r.zkey=d.matrix[2]*r.position[0]+d.matrix[6]*r.position[1]+d.matrix[10]*r.position[2]+d.matrix[14]}h.particles.sort(function(e,t){return e.zkey-t.zkey});let f=h.positionArrayOffset,l=h.eulerArrayOffset,c=h.miscArrayOffset;for(let e=0;e<h.numFlowers;e++){let t=h.particles[e];h.dataArray[f]=t.position[0],h.dataArray[f+1]=t.position[1],h.dataArray[f+2]=t.position[2],f+=3,h.dataArray[l]=t.euler[0],h.dataArray[l+1]=t.euler[1],h.dataArray[l+2]=t.euler[2],l+=3,h.dataArray[c]=t.size,h.dataArray[c+1]=t.alpha,c+=2}r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);let E=h.program;u(E),r.uniformMatrix4fv(E.uniforms.uProjection,!1,m.matrix),r.uniformMatrix4fv(E.uniforms.uModelview,!1,d.matrix),r.uniform3fv(E.uniforms.uResolution,n.array),r.uniform3fv(E.uniforms.uDOF,a.arrayForm(d.dof)),r.uniform3fv(E.uniforms.uFade,a.arrayForm(h.fader)),r.bindBuffer(r.ARRAY_BUFFER,h.buffer),r.bufferData(r.ARRAY_BUFFER,h.dataArray,r.DYNAMIC_DRAW),r.vertexAttribPointer(E.attributes.aPosition,3,r.FLOAT,!1,0,h.positionArrayOffset*Float32Array.BYTES_PER_ELEMENT),r.vertexAttribPointer(E.attributes.aEuler,3,r.FLOAT,!1,0,h.eulerArrayOffset*Float32Array.BYTES_PER_ELEMENT),r.vertexAttribPointer(E.attributes.aMisc,2,r.FLOAT,!1,0,h.miscArrayOffset*Float32Array.BYTES_PER_ELEMENT);for(let e=1;e<2;e++){let t=-2*e;h.offset[0]=-1*h.area.x,h.offset[1]=-1*h.area.y,h.offset[2]=h.area.z*t,r.uniform3fv(E.uniforms.uOffset,h.offset),r.drawArrays(r.POINT,0,h.numFlowers),h.offset[0]=-1*h.area.x,h.offset[1]=1*h.area.y,h.offset[2]=h.area.z*t,r.uniform3fv(E.uniforms.uOffset,h.offset),r.drawArrays(r.POINT,0,h.numFlowers),h.offset[0]=1*h.area.x,h.offset[1]=-1*h.area.y,h.offset[2]=h.area.z*t,r.uniform3fv(E.uniforms.uOffset,h.offset),r.drawArrays(r.POINT,0,h.numFlowers),h.offset[0]=1*h.area.x,h.offset[1]=1*h.area.y,h.offset[2]=h.area.z*t,r.uniform3fv(E.uniforms.uOffset,h.offset),r.drawArrays(r.POINT,0,h.numFlowers)}h.offset[0]=0,h.offset[1]=0,h.offset[2]=0,r.uniform3fv(E.uniforms.uOffset,h.offset),r.drawArrays(r.POINT,0,h.numFlowers),r.bindBuffer(r.ARRAY_BUFFER,null),s(E),r.enable(r.DEPTH_TEST),r.disable(r.BLEND)}(),function(){r.enable(r.TEXTURE_2D),r.disable(r.DEPTH_TEST);let e=function(e,t){r.bindFramebuffer(r.FRAMEBUFFER,e.frameBuffer),r.viewport(0,0,e.width,e.height),t&&(r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT))};e(n.wHalfRT0,!0),y(F.mkBrightBuf,n.mainRT),T(F.mkBrightBuf),A(F.mkBrightBuf);for(let t=0;t<2;t++){let a=1.5+1*t,i=2+1*t;e(n.wHalfRT1,!0),y(F.dirBlur,n.wHalfRT0),r.uniform4f(F.dirBlur.program.uniforms.uBlurDir,a,0,i,0),T(F.dirBlur),A(F.dirBlur),e(n.wHalfRT0,!0),y(F.dirBlur,n.wHalfRT1),r.uniform4f(F.dirBlur.program.uniforms.uBlurDir,0,a,0,i),T(F.dirBlur),A(F.dirBlur)}r.bindFramebuffer(r.FRAMEBUFFER,null),r.viewport(0,0,n.width,n.height),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),y(F.finalComp,n.mainRT),r.uniform1i(F.finalComp.program.uniforms.uBloom,1),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,n.wHalfRT0.texture),T(F.finalComp),A(F.finalComp),r.enable(r.DEPTH_TEST)}()}()}),t="equestAnimationFrame",(e=window)["r"+t]=e["r"+t]||e["webkitR"+t]||e["mozR"+t]||e["msR"+t]||e["oR"+t]||function(t){e.setTimeout(t,1e3/60)};